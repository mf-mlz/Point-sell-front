<!-- Filter Input-->
<div class="col-12 col-sm-12 col-md-6 col-lg-6 mb-4">
  <div class="form-group d-flex align-items-center">
    <input id="search" class="form-control me-2 flex-grow-1" placeholder="Ingresa el Sku / Descripción" [(ngModel)]="searchInput"/>
    <button class="btn btn-primary fw-bold btn-product" (click)="filterProducts('input')">Buscar</button>
    <button class="btn btn-success fw-bold btn-product mx-2" style="width: 40%;color:white;" (click)="getAllProducts()">Ver Todos</button>
  </div>
</div>

<!-- Filter Categories-->
<div class="row">
  <div
    *ngFor="let category of categories"
    class="col-lg-3 col-md-3 col-sm-6 mb-4 d-flex justify-content-center"
  >
    <button
      [ngClass]="'span-color ' + category.category"
      class="text-center btn-category"
      (click)="filterProducts('category', category.category)"
    >
      {{ category.category }}
    </button>
  </div>
</div>

<div class="row">
  <!-- Products -->
  <div
    class="col-12 col-sm-6 col-md-4 col-lg-3 mb-4"
    *ngFor="let product of products"
  >
    <div class="p-3 border rounded text-center">
      <img
        class="theme-color w-100 rounded mb-3 bg-primary"
        style="height: 250px"
        [src]="apiUpload + product.photo"
      />
      <h5>{{ product.name }}</h5>
      <span>Sku: {{product.id}}</span>
      <br>
      <div [ngClass]="'span-color ' + product.category">
        <b>{{ product.category }}</b>
      </div>
      <b> Stock: </b>
      <b [ngClass]="{ 'text-danger': product.stock <= 10 }">{{
        product.stock
      }}</b>
      <br />
      <span class="text-success fw-bold">${{ product.price }}</span>
      <div class="d-flex justify-content-center my-2">
        <button
          class="btn btn-primary me-2 fw-bold btn-product"
          (click)="
            showModal(product, 'Ver Datos del Producto', 'eye', product.photo)
          "
        >
          Ver
        </button>
        <button
          class="btn btn-warning me-2 fw-bold btn-product"
          (click)="showModal(product, 'Editar Producto', 'edit', product.photo)"
          *ngIf="userPayload.role_name === 'Administrador'"
        >
          Editar
        </button>
        <button
          class="btn btn-danger fw-bold btn-product"
          (click)="showModaldeleteProduct(product.id)"
          *ngIf="userPayload.role_name === 'Administrador'"
        >
          Eliminar
        </button>
      </div>
    </div>
    <!-- Modal Component (Edit Product) -->
    <app-modal
      [visible]="isModalVisible"
      (visibleChange)="handleModalVisibilityChange($event)"
      [title]="titleModal"
      [class]="classModal"
      (executeFunction)="editProduct()"
    >
      <!-- Img Product => View -->
      <div
        class="form-group d-flex justify-content-center"
        *ngIf="classModal === 'eye'"
      >
        <img
          class="theme-color w-80 rounded mb-3 bg-primary"
          style="height: 250px"
          [src]="apiUpload + nameFile"
        />
      </div>
      <form
        [formGroup]="productForm"
        class="product-form"
        [ngClass]="classModal"
      >
        <div class="form-group">
          <label for="name">Name:</label>
          <input id="name" formControlName="name" class="form-control" />
          <div
            *ngIf="isFieldInvalid(productForm, 'name')"
            class="error-message"
          >
            {{ getErrorMessage(productForm, "name") }}
          </div>
        </div>

        <div class="form-group">
          <label for="description">Description:</label>
          <input
            id="description"
            formControlName="description"
            class="form-control"
          />
          <div
            *ngIf="isFieldInvalid(productForm, 'description')"
            class="error-message"
          >
            {{ getErrorMessage(productForm, "description") }}
          </div>
        </div>

        <div class="form-group">
          <label for="price">Price:</label>
          <input
            id="price"
            type="number"
            formControlName="price"
            class="form-control"
          />
          <div
            *ngIf="isFieldInvalid(productForm, 'price')"
            class="error-message"
          >
            {{ getErrorMessage(productForm, "price") }}
          </div>
        </div>

        <div class="form-group">
          <label for="category">Category:</label>
          <select id="category" formControlName="category" class="form-control">
            <option value="">Selecciona una Categoría</option>
            <option *ngFor="let cat of categories" [value]="cat.category">
              {{ cat.category }}
            </option>
          </select>
          <div
            *ngIf="isFieldInvalid(productForm, 'category')"
            class="error-message"
          >
            {{ getErrorMessage(productForm, "category") }}
          </div>
        </div>

        <div class="form-group">
          <label for="stock">Stock:</label>
          <input
            id="stock"
            type="number"
            formControlName="stock"
            class="form-control"
          />
          <div
            *ngIf="isFieldInvalid(productForm, 'stock')"
            class="error-message"
          >
            {{ getErrorMessage(productForm, "stock") }}
          </div>
        </div>
        <div class="form-group">
          <label for="key_sat">Clave de Producto:</label>
          <input
            id="key_sat"
            type="text"
            formControlName="key_sat"
            class="form-control"
            list="key_sat_options"
            (input)="filterKeySat($event)"
          />
          <datalist id="key_sat_options">
            <option *ngFor="let key of filteredKeySat" [value]="key.clave">
              {{ key.clave }} - {{ key.descripcion }}
            </option>
          </datalist>
          <div
            *ngIf="isFieldInvalid(productForm, 'key_sat')"
            class="error-message"
          >
            {{ getErrorMessage(productForm, "key_sat") }}
          </div>
        </div>
        <div class="form-group" *ngIf="classModal !== 'eye'">
          <label for="photoUpload">Foto:</label>
          <input
            type="file"
            id="photoUpload"
            formControlName="photoUpload"
            class="form-control"
            (change)="onFileSelected($event)"
            accept="image/*"
            required
          />
          <div
            *ngIf="isFieldInvalid(productForm, 'photoUpload')"
            class="error-message"
          >
            {{ getErrorMessage(productForm, "photoUpload") }}
          </div>
        </div>

        <div class="form-group hidden">
          <input
            id="photo"
            type="text"
            formControlName="photo"
            class="form-control"
          />
          <input
            id="id"
            type="number"
            formControlName="id"
            class="form-control"
          />
        </div>
      </form>
    </app-modal>
  </div>
</div>
